# 基于基础镜像：python:3.11-slim
FROM python:3.11-slim

# 环境变量：确保 Python 日志实时输出
ENV PYTHONUNBUFFERED=1

# 环境变量：定义应用的根目录，统一路径规范
ENV APP_HOME=/app

# 环境变量：定义torchscript模型路径
ENV MODEL_PATH=/app/torchscript/wafermap_defect_ts_model.pt

# 环境变量：定义CLIP预训练模型的路径
ENV CLIP_MODEL_PATH=/app/models/clip-vit-base-patch32

# 工作目录
WORKDIR ${APP_HOME}

# 在安装依赖前，先创建 pip 配置文件，永久指定阿里云源
RUN mkdir -p /root/.pip && \
    echo "[global]" > /root/.pip/pip.conf && \
    echo "index-url = https://mirrors.aliyun.com/pypi/simple/" >> /root/.pip/pip.conf && \
    echo "[install]" >> /root/.pip/pip.conf && \
    echo "trusted-host = mirrors.aliyun.com" >> /root/.pip/pip.conf

# 安装系统依赖
RUN apt-get update && apt-get install -y --no-install-recommends \
    curl ca-certificates && \
    rm -rf /var/lib/apt/lists/*

# 拷贝到当前工作目录/app下，并安装依赖
COPY requirements.txt ./

# 依赖包安装
RUN pip install -U pip --default-timeout=120 && \
    pip install -r requirements.txt --default-timeout=120

# 清理系统缓存
RUN apt-get clean && rm -rf /tmp/* /var/tmp/*

# 拷贝app.py和torchscript文件夹到当前工作目录/app下
# 对应容器内路径：/app/app.py
COPY app.py ./
# 对应容器内路径：/app/torchscript
COPY torchscript ./torchscript
# 对应容器内路径：/app/models/clip-vit-base-patch32
COPY ../models/clip-vit-base-patch32 ./models/clip-vit-base-patch32

# 暴露对外端口
EXPOSE 8802

# 健康检查（可选）
HEALTHCHECK --interval=60s --timeout=10s --start-period=30s CMD curl -f http://127.0.0.1:8802/healthz || exit 1

# 启动服务应用
CMD ["python", "app.py"]